<!doctype html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.webmanifest">
<script>if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js');}</script>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#ffffff">
<title>Nail Price Calculator</title>
<style>
  :root { --pad:12px; --gap:10px; --radius:12px; --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  * { box-sizing: border-box; }
  body { font-family: var(--font); margin:0; background:#f7f7f8; color:#111; }
  header { position:sticky; top:0; background:#fff; padding:14px; border-bottom:1px solid #e5e5e7; z-index:5; }
  h1 { margin:0; font-size:18px; }
  .tabs { display:flex; gap:8px; margin-top:10px; }
  .tab { flex:1; text-align:center; padding:10px; border:1px solid #ddd; border-radius:10px; background:#fff; }
  .tab.active { background:#111; color:#fff; border-color:#111; }
  main { padding: var(--pad); }
  .card { background:#fff; border:1px solid #e5e5e7; border-radius:var(--radius); padding:var(--pad); margin-bottom:12px; }
  .row { display:flex; gap:var(--gap); }
  .col { flex:1; }
  label { display:block; font-size:12px; color:#555; margin-bottom:6px; }
  input, select, textarea { width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; background:#fff; font-size:16px; }
  input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid #ddd; border-radius:999px; background:#fff; margin:4px 6px 0 0; }
  .btn { width:100%; padding:12px 14px; border-radius:10px; border:1px solid #111; background:#111; color:#fff; font-weight:600; font-size:16px; }
  .btn.secondary { background:#fff; color:#111; }
  .btn.inline { width:auto; }
  .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .right { text-align:right; }
  .muted { color:#666; font-size:12px; }
  .total { font-size:22px; font-weight:800; }
  .breakdown { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:14px; white-space:pre-wrap; }
  .footer-actions { position:sticky; bottom:0; background:#fff; padding:10px; border-top:1px solid #e5e5e7; display:flex; gap:10px; }
  .hint { font-size:12px; color:#777; margin-top:6px; }
  .hr { height:1px; background:#eee; margin:10px 0; }
  .tag { background:#eef2ff; border:1px solid #dbe3ff; color:#223; padding:4px 8px; border-radius:999px; font-size:12px; display:inline-block; }
</style>
</head>
<body>
<header>
  <h1>Nail Price Calculator</h1>
  <div class="tabs">
    <button class="tab active" data-tab="calc">Calculator</button>
    <button class="tab" data-tab="settings">Settings</button>
  </div>
</header>

<main>
  <!-- CALCULATOR -->
  <section id="calc" class="tabpane">
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Client name (optional)</label>
          <input id="clientName" placeholder="e.g., Alex R.">
        </div>
        <div class="col">
          <label>Date</label>
          <input id="visitDate" type="date">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="grid2">
        <div>
          <label>Service type</label>
          <select id="serviceType"></select>
        </div>
        <div>
          <label>Material</label>
          <select id="material"></select>
        </div>
        <div>
          <label>Length</label>
          <select id="length"></select>
        </div>
        <div>
          <label>Style complexity</label>
          <select id="style"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label>Gems count</label>
          <input id="gemsCount" type="number" inputmode="numeric" min="0" value="0">
          <div class="hint">Per-gem price set in Settings.</div>
        </div>
        <div class="col">
          <label>Custom line item ($)</label>
          <input id="customLine" type="number" inputmode="decimal" min="0" step="0.01" placeholder="0.00">
          <div class="hint">Use for one-off art or repairs.</div>
        </div>
      </div>

      <div class="hr"></div>
      <label>Add-ons</label>
      <div id="addonsArea"></div>

      <div class="hr"></div>
      <div class="grid2">
        <div>
          <label>Time (minutes)</label>
          <input id="minutes" type="number" inputmode="numeric" min="0" value="0">
        </div>
        <div>
          <label>Discount (%)</label>
          <input id="discountPct" type="number" inputmode="decimal" min="0" max="100" value="0">
        </div>
        <div>
          <label>Tax (%)</label>
          <input id="taxPct" type="number" inputmode="decimal" min="0" step="0.01">
        </div>
        <div>
          <label>Tip ($)</label>
          <input id="tip" type="number" inputmode="decimal" min="0" step="0.01" value="0">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <div class="muted">Subtotal</div>
          <div id="subtotal" class="total">$0.00</div>
        </div>
        <div class="col right">
          <div class="muted">Total</div>
          <div id="total" class="total">$0.00</div>
        </div>
      </div>
      <div class="breakdown" id="breakdown"></div>
    </div>

    <div class="footer-actions">
      <button class="btn secondary" id="resetBtn">Reset</button>
      <button class="btn" id="calcBtn">Calculate</button>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="tabpane" hidden>
    <div class="card">
      <div class="grid2">
        <div>
          <label>Hourly labor rate ($/hr)</label>
          <input id="laborRate" type="number" inputmode="decimal" min="0" step="0.01" value="60">
        </div>
        <div>
          <label>Default tax (%)</label>
          <input id="defaultTax" type="number" inputmode="decimal" min="0" step="0.01" value="0">
        </div>
        <div>
          <label>Per-gem price ($)</label>
          <input id="perGem" type="number" inputmode="decimal" min="0" step="0.01" value="0.50">
        </div>
        <div>
          <label>Currency symbol</label>
          <input id="currency" placeholder="$" value="$">
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0; font-size:16px;">Price tables</h3>
      <div class="hint">Edit labels and prices. Add or remove rows as needed.</div>

      <div class="hr"></div>
      <div>
        <span class="tag">Service types</span>
        <div id="serviceTypesTable"></div>
        <button class="btn secondary inline" data-add="serviceTypes">Add row</button>
      </div>

      <div class="hr"></div>
      <div>
        <span class="tag">Materials (adder)</span>
        <div id="materialsTable"></div>
        <button class="btn secondary inline" data-add="materials">Add row</button>
      </div>

      <div class="hr"></div>
      <div>
        <span class="tag">Lengths (adder)</span>
        <div id="lengthsTable"></div>
        <button class="btn secondary inline" data-add="lengths">Add row</button>
      </div>

      <div class="hr"></div>
      <div>
        <span class="tag">Style complexity (adder)</span>
        <div id="stylesTable"></div>
        <button class="btn secondary inline" data-add="styles">Add row</button>
      </div>

      <div class="hr"></div>
      <div>
        <span class="tag">Add-ons (each)</span>
        <div id="addonsTable"></div>
        <button class="btn secondary inline" data-add="addons">Add row</button>
      </div>
    </div>

    <div class="footer-actions">
      <button class="btn secondary" id="restoreBtn">Restore defaults</button>
      <button class="btn" id="saveBtn">Save settings</button>
    </div>
  </section>
</main>

<script>
const $ = (id) => document.getElementById(id);
const fmt = (n, cur) => `${cur}${Number(n || 0).toFixed(2)}`;

const DEFAULTS = {
  currency: "$",
  laborRate: 60,            // $/hour
  defaultTax: 0,            // %
  perGem: 0.50,             // $ each
  serviceTypes: [           // base prices
    { label: "Full set", price: 65 },
    { label: "Fill", price: 45 },
    { label: "Manicure", price: 30 },
    { label: "Repair (per nail)", price: 8 }
  ],
  materials: [              // adders
    { label: "Acrylic", price: 0 },
    { label: "Hard gel", price: 10 },
    { label: "Poly/Builder gel", price: 8 },
    { label: "Dip", price: 5 }
  ],
  lengths: [
    { label: "Short", price: 0 },
    { label: "Medium", price: 5 },
    { label: "Long", price: 10 },
    { label: "XL", price: 20 }
  ],
  styles: [
    { label: "Simple", price: 0 },
    { label: "Detailed", price: 10 },
    { label: "Complex / 3D", price: 20 }
  ],
  addons: [
    { label: "French tips", price: 12 },
    { label: "Chrome", price: 10 },
    { label: "Hand-painted art", price: 15 },
    { label: "Encapsulated design", price: 15 }
  ]
};

function loadSettings() {
  const s = JSON.parse(localStorage.getItem("nailPricer") || "null") || DEFAULTS;
  // merge to keep future keys
  const merged = JSON.parse(JSON.stringify(DEFAULTS));
  Object.keys(s).forEach(k => merged[k] = s[k]);
  return merged;
}
function saveSettings(data) {
  localStorage.setItem("nailPricer", JSON.stringify(data));
}

let settings = loadSettings();

function buildTable(containerId, arr, keys = ["label","price"]) {
  const wrap = $(containerId);
  wrap.innerHTML = "";
  arr.forEach((row, idx) => {
    const div = document.createElement("div");
    div.className = "row";
    div.style.margin = "8px 0";
    div.innerHTML = `
      <div class="col">
        <label>Label</label>
        <input data-key="${containerId}" data-idx="${idx}" data-field="${keys[0]}" value="${row[keys[0]]}">
      </div>
      <div class="col">
        <label>Price ($)</label>
        <input type="number" step="0.01" inputmode="decimal" min="0" data-key="${containerId}" data-idx="${idx}" data-field="${keys[1]}" value="${row[keys[1]]}">
      </div>
      <div style="display:flex; align-items:flex-end">
        <button class="btn secondary inline" data-del="${containerId}" data-idx="${idx}" title="Delete">Remove</button>
      </div>
    `;
    wrap.appendChild(div);
  });
}

function renderSettingsUI() {
  $("laborRate").value = settings.laborRate;
  $("defaultTax").value = settings.defaultTax;
  $("perGem").value = settings.perGem;
  $("currency").value = settings.currency;

  buildTable("serviceTypesTable", settings.serviceTypes);
  buildTable("materialsTable", settings.materials);
  buildTable("lengthsTable", settings.lengths);
  buildTable("stylesTable", settings.styles);
  buildTable("addonsTable", settings.addons);
}

function renderCalcSelectors() {
  const fillSelect = (el, arr) => {
    el.innerHTML = arr.map((o,i)=>`<option value="${i}">${o.label} (${settings.currency}${Number(o.price).toFixed(2)})</option>`).join("");
  };
  fillSelect($("serviceType"), settings.serviceTypes);
  fillSelect($("material"), settings.materials);
  fillSelect($("length"), settings.lengths);
  fillSelect($("style"), settings.styles);

  // Add-ons checkboxes
  const a = $("addonsArea");
  a.innerHTML = settings.addons.map((o,i)=>`
    <label class="pill"><input type="checkbox" data-addon="${i}"> ${o.label} ${settings.currency}${Number(o.price).toFixed(2)}</label>
  `).join("");
  // Defaults
  $("taxPct").value = settings.defaultTax;
}

function calcTotal() {
  const cur = settings.currency;
  const svc = settings.serviceTypes[$("serviceType").value] || {price:0,label:""};
  const mat = settings.materials[$("material").value] || {price:0,label:""};
  const len = settings.lengths[$("length").value] || {price:0,label:""};
  const sty = settings.styles[$("style").value] || {price:0,label:""};

  const gemsCount = Number($("gemsCount").value || 0);
  const customLine = Number($("customLine").value || 0);
  const minutes = Number($("minutes").value || 0);
  const discountPct = Number($("discountPct").value || 0);
  const taxPct = Number($("taxPct").value || 0);
  const tip = Number($("tip").value || 0);

  // Add-ons
  let addonsSum = 0;
  let addonsList = [];
  [...document.querySelectorAll('[data-addon]')].forEach(cb=>{
    if (cb.checked) {
      const idx = Number(cb.getAttribute('data-addon'));
      const a = settings.addons[idx];
      addonsSum += Number(a.price || 0);
      addonsList.push(`${a.label} ${fmt(a.price, cur)}`);
    }
  });

  const labor = (settings.laborRate / 60) * minutes;
  const gemsSum = settings.perGem * gemsCount;

  const base = Number(svc.price||0);
  const adders = Number(mat.price||0) + Number(len.price||0) + Number(sty.price||0);
  const subtotalBeforeDiscount = base + adders + addonsSum + gemsSum + labor + customLine;

  const discount = subtotalBeforeDiscount * (discountPct/100);
  const taxable = subtotalBeforeDiscount - discount;
  const tax = taxable * (taxPct/100);
  const total = taxable + tax + tip;

  $("subtotal").textContent = fmt(subtotalBeforeDiscount, cur);
  $("total").textContent = fmt(total, cur);

  const lines = [];
  lines.push(`Service: ${svc.label}  ${fmt(base, cur)}`);
  lines.push(`Material: ${mat.label}  +${fmt(mat.price, cur)}`);
  lines.push(`Length: ${len.label}     +${fmt(len.price, cur)}`);
  lines.push(`Style: ${sty.label}      +${fmt(sty.price, cur)}`);
  if (addonsList.length) lines.push(`Add-ons: ${addonsList.join(", ")}  +${fmt(addonsSum, cur)}`);
  if (gemsCount>0) lines.push(`Gems: ${gemsCount} × ${fmt(settings.perGem, cur)}  +${fmt(gemsSum, cur)}`);
  if (minutes>0) lines.push(`Time: ${minutes} min @ ${fmt(settings.laborRate, cur)}/hr  +${fmt(labor, cur)}`);
  if (customLine>0) lines.push(`Custom line item  +${fmt(customLine, cur)}`);
  lines.push(`Subtotal: ${fmt(subtotalBeforeDiscount, cur)}`);
  if (discountPct>0) lines.push(`Discount (${discountPct}%): −${fmt(discount, cur)}`);
  if (taxPct>0) lines.push(`Tax (${taxPct}%): +${fmt(tax, cur)}`);
  if (tip>0) lines.push(`Tip: +${fmt(tip, cur)}`);
  lines.push(`TOTAL: ${fmt(total, cur)}`);

  const name = $("clientName").value?.trim();
  const date = $("visitDate").value;
  const header = [];
  if (name) header.push(`Client: ${name}`);
  if (date) header.push(`Date: ${date}`);
  $("breakdown").textContent = (header.length?header.join("   ")+"\n":"") + lines.join("\n");

  // persist last used calc inputs
  const calcState = {
    clientName: $("clientName").value, visitDate: $("visitDate").value,
    serviceType: $("serviceType").value, material: $("material").value,
    length: $("length").value, style: $("style").value,
    gemsCount, customLine, minutes, discountPct, taxPct, tip,
    addonsChecked: [...document.querySelectorAll('[data-addon]')].map(cb=>cb.checked)
  };
  localStorage.setItem("nailPricer_calcState", JSON.stringify(calcState));
}

function restoreCalcState() {
  const s = JSON.parse(localStorage.getItem("nailPricer_calcState") || "null");
  if (!s) return;
  $("clientName").value = s.clientName || "";
  $("visitDate").value = s.visitDate || "";
  $("serviceType").value = s.serviceType || 0;
  $("material").value = s.material || 0;
  $("length").value = s.length || 0;
  $("style").value = s.style || 0;
  $("gemsCount").value = s.gemsCount || 0;
  $("customLine").value = s.customLine || 0;
  $("minutes").value = s.minutes || 0;
  $("discountPct").value = s.discountPct || 0;
  $("taxPct").value = (s.taxPct ?? settings.defaultTax);
  $("tip").value = s.tip || 0;
  const boxes = [...document.querySelectorAll('[data-addon]')];
  (s.addonsChecked || []).forEach((v,i)=>{ if (boxes[i]) boxes[i].checked = !!v; });
}

function switchTab(tab) {
  [...document.querySelectorAll(".tab")].forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
  [...document.querySelectorAll(".tabpane")].forEach(p=>p.hidden = (p.id !== tab));
}

function todayISO(){
  const d = new Date();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${d.getFullYear()}-${mm}-${dd}`;
}

/* Event wiring */
document.addEventListener("click", (e)=>{
  const t = e.target;
  if (t.classList.contains("tab")) switchTab(t.dataset.tab);

  if (t.matches("[data-add]")) {
    const keyMap = {
      serviceTypes:"serviceTypes", materials:"materials",
      lengths:"lengths", styles:"styles", addons:"addons"
    };
    const key = keyMap[t.getAttribute("data-add")];
    settings[key].push({label:"New", price:0});
    renderSettingsUI();
  }
  if (t.matches("[data-del]")) {
    const keyById = {
      serviceTypesTable:"serviceTypes",
      materialsTable:"materials",
      lengthsTable:"lengths",
      stylesTable:"styles",
      addonsTable:"addons"
    };
    const key = keyById[t.getAttribute("data-del")];
    const idx = Number(t.getAttribute("data-idx"));
    settings[key].splice(idx,1);
    renderSettingsUI();
  }
});

document.addEventListener("input", (e)=>{
  const t = e.target;
  if (t.dataset && t.dataset.key) {
    // editing settings tables live
    const idToKey = {
      serviceTypesTable:"serviceTypes",
      materialsTable:"materials",
      lengthsTable:"lengths",
      stylesTable:"styles",
      addonsTable:"addons"
    };
    const arr = settings[idToKey[t.dataset.key]];
    const idx = Number(t.dataset.idx);
    const field = t.dataset.field;
    if (field === "price") arr[idx][field] = Number(t.value || 0);
    else arr[idx][field] = t.value;
  }
});

$("saveBtn").addEventListener("click", ()=>{
  settings.laborRate = Number($("laborRate").value || 0);
  settings.defaultTax = Number($("defaultTax").value || 0);
  settings.perGem = Number($("perGem").value || 0);
  settings.currency = $("currency").value || "$";
  saveSettings(settings);
  renderCalcSelectors();
  alert("Saved.");
});

$("restoreBtn").addEventListener("click", ()=>{
  if (!confirm("Restore default pricing? This will overwrite current settings.")) return;
  settings = JSON.parse(JSON.stringify(DEFAULTS));
  saveSettings(settings);
  renderSettingsUI();
  renderCalcSelectors();
});

$("calcBtn").addEventListener("click", calcTotal);

$("resetBtn").addEventListener("click", ()=>{
  localStorage.removeItem("nailPricer_calcState");
  document.querySelector("#calc").querySelectorAll("input").forEach(i=>{
    if (i.type==="date") i.value = todayISO();
    else if (i.type==="number") i.value = 0;
    else i.value = "";
  });
  document.querySelectorAll("[data-addon]").forEach(cb=>cb.checked=false);
  $("discountPct").value = 0;
  $("taxPct").value = settings.defaultTax;
  $("tip").value = 0;
  $("serviceType").value = 0;
  $("material").value = 0;
  $("length").value = 0;
  $("style").value = 0;
  $("breakdown").textContent = "";
  $("subtotal").textContent = fmt(0, settings.currency);
  $("total").textContent = fmt(0, settings.currency);
});

/* Init */
(function init(){
  renderSettingsUI();
  renderCalcSelectors();
  $("visitDate").value = todayISO();
  restoreCalcState();
  calcTotal();
})();
</script>
</body>
</html>
